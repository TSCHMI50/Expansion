#Python


from google.cloud import storage
import os
import datetime


from datetime import datetime, timedelta
import os
from google.cloud import storage
quadkeys = [1202210,1202211,1202212,1202213]

# Initialize a client with the appropriate project and credentials
client = storage.Client(project="cube-ch-be59") 

for quadkey in quadkeys:
    # Specify the base directory where you want to store the downloaded files
    #base_dir = "C:/Users/Tim/Documents/Footfall/1202210/2022/"
    base_dir = f"D:/driving_activity/{quadkey}/{year}/"

    # Define the range of dates you want to download data for
    start_date = datetime(2024, 1, 1)
    end_date = datetime(2024, 5, 29)

    # Iterate over the range of dates
    current_date = start_date
    while current_date <= end_date:
        # Extract month and day from the current date
        mm = current_date.strftime("%m")
        dd = current_date.strftime("%d")
        yy = f'20{current_date.strftime("%y")}'
        # Specify the URI for the current date
        uri = f"gs://mapbox-movement-decathlon-shared/v0.2/daily-24h/v4.0.0/CH/quadkey/driving/{yy}/{mm}/{dd}/data/{quadkey}.csv"

        # Parse the bucket name and object name from the URI
        uri_parts = uri.split("/")
        bucket_name = uri_parts[2]
        blob_name = "/".join(uri_parts[3:])

        # Get the bucket
        bucket = client.get_bucket(bucket_name)

        # Get the blob (object)
        blob = bucket.blob(blob_name)

        # Specify the local file path where you want to save the downloaded file
        local_file_path = os.path.join(base_dir, f"{mm}/{dd}/{quadkey}_{yy}_{mm}_{dd}.csv")

        # Create directories if they don't exist
        os.makedirs(os.path.dirname(local_file_path), exist_ok=True)

        # Download the file to the local machine
        blob.download_to_filename(local_file_path)

        print(f"File downloaded for date {current_date.strftime('%Y-%m-%d')}: Quadkey {quadkey}")

        # Move to the next date
        current_date += timedelta(days=1)

